<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HỆ THỐNG THI TRẮC NGHIỆM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .option-label.selected { background-color: #3b82f6; color: white; border-color: #2563eb; }
        .option-label.correct { background-color: #22c55e !important; color: white !important; border-color: #16a34a !important; }
        .option-label.incorrect { background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
        .question-grid-btn { border: 1px solid #d1d5db; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: 600; border-radius: 0.375rem; transition: all 0.2s ease-in-out; }
        .question-grid-btn.current { background-color: #3b82f6; color: white; border-color: #2563eb; }
        .question-grid-btn.answered { background-color: #22c55e; color: white; border-color: #16a34a; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9990; display: flex; align-items: center; justify-content: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden"><div class="bg-white p-4 rounded-lg shadow-xl flex items-center gap-4"><div class="spinner"></div><span>Đang xử lý...</span></div></div>

    <!-- MÀN HÌNH ĐĂNG NHẬP -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center">Đăng Nhập</h1>
            <p class="text-gray-500 text-center mt-2 mb-8">Vui lòng nhập thông tin để bắt đầu bài thi.</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Tên đăng nhập (UserID)</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="student1" required>
                </div>
                <div class="mb-4">
                    <label for="exam-code" class="block text-sm font-medium text-gray-700 mb-1">Mã đề thi</label>
                    <input type="text" id="exam-code" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="PRJ311" required>
                </div>
                <p id="login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <button type="button" id="login-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Bắt đầu làm bài</button>
            </form>
        </div>
    </div>

    <!-- MÀN HÌNH LÀM BÀI THI -->
    <div id="quiz-screen" class="hidden w-full max-w-6xl mx-auto bg-white rounded-xl shadow-lg my-8 p-6 md:p-8">
        <div class="flex justify-between items-center border-b pb-4 mb-6">
            <div><h1 id="exam-title" class="text-2xl md:text-3xl font-bold text-gray-800"></h1><p id="student-info" class="text-gray-500 mt-1"></p></div>
            <div class="text-right"><p class="text-sm text-gray-600">Thời gian còn lại</p><p id="timer" class="text-3xl font-bold text-red-500">15:00</p></div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2"><div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div>
        <p id="question-counter" class="text-sm font-medium text-gray-600 mb-6 text-right"></p>
        <div class="flex flex-col md:flex-row gap-6 min-h-[350px]">
            <div class="w-full md:w-1/2">
                <h2 id="question" class="text-xl font-semibold text-gray-900 mb-6 flex-1"></h2>
                <div id="options" class="space-y-3"></div>
            </div>
            <div class="hidden md:block w-1 bg-red-500 rounded-full"></div>
            <div class="w-full md:w-1/2 flex items-center justify-center bg-gray-50 rounded-lg p-4">
                <img id="question-image" src="" alt="Hình ảnh minh họa" class="max-w-full max-h-full object-contain hidden">
                <p id="no-image-text" class="text-gray-400">Câu hỏi này không có hình ảnh.</p>
            </div>
        </div>
        <div class="border-t pt-6 mt-6">
            <p class="font-semibold mb-3 text-gray-700">Chuyển câu:</p>
            <div id="question-grid" class="flex flex-wrap gap-2 mb-6"></div>
            <div class="flex justify-between items-center">
                <button id="prev-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 disabled:opacity-50">Trước</button>
                <button id="next-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Tiếp</button>
                <button id="submit-btn" class="hidden bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Nộp bài</button>
            </div>
        </div>
    </div>
    
    <!-- MÀN HÌNH KẾT QUẢ -->
    <div id="result-screen" class="hidden w-full max-w-4xl mx-auto bg-white rounded-xl shadow-lg my-8 p-6 md:p-8">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Kết Quả Bài Thi</h2>
            <div class="inline-block bg-blue-100 border-2 border-blue-300 rounded-lg p-4 mt-4">
                <p class="text-gray-700 mb-1">Điểm số của bạn</p><p class="text-5xl font-bold text-blue-600" id="score"></p>
            </div>
        </div>
        <div id="review-section" class="border-t pt-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Xem lại bài làm</h3>
            <div id="review-questions-container" class="space-y-6"></div>
        </div>
        <div class="text-center mt-8">
             <button id="logout-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700">Về trang đăng nhập</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        function main() {
            // ==================================================================
            // UPDATED: Replaced placeholder with the user's actual firebaseConfig
            // ==================================================================
            const firebaseConfig = {
                apiKey: "AIzaSyDG_7j_aXI9kp5C_hVxuOUhA7dMb_XY8ck",
                authDomain: "httn-tf-01.firebaseapp.com",
                projectId: "httn-tf-01",
                storageBucket: "httn-tf-01.firebasestorage.app",
                messagingSenderId: "952866478297",
                appId: "1:952866478297:web:9a9ca4124ed5e8d99106c8",
                measurementId: "G-EREBQ1LNSG"
            };
            // ==================================================================

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-quiz-app';

            const loadingOverlay = document.getElementById('loading-overlay');
            const loginScreen = document.getElementById('login-screen');
            const quizScreen = document.getElementById('quiz-screen');
            const resultScreen = document.getElementById('result-screen');
            const loginBtn = document.getElementById('login-btn');
            const loginError = document.getElementById('login-error');
            const questionEl = document.getElementById('question');
            const optionsEl = document.getElementById('options');
            const questionCounterEl = document.getElementById('question-counter');
            const progressBar = document.getElementById('progress-bar');
            const timerEl = document.getElementById('timer');
            const questionImage = document.getElementById('question-image');
            const noImageText = document.getElementById('no-image-text');
            const questionGrid = document.getElementById('question-grid');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const scoreEl = document.getElementById('score');
            const examTitleEl = document.getElementById('exam-title');
            const studentInfoEl = document.getElementById('student-info');
            const reviewContainer = document.getElementById('review-questions-container');

            let currentQuestionIndex = 0, userAnswers = [], timerInterval, quizData = [], currentUser = null, currentExamCode = '';

            const showLoading = (show) => {
                loadingOverlay.classList.toggle('hidden', !show);
            }

            loginBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                
                const userIdInput = document.getElementById('username');
                const examCodeInput = document.getElementById('exam-code');
                
                if (!userIdInput.value.trim() || !examCodeInput.value.trim()) {
                    loginError.innerText = "Vui lòng nhập đầy đủ thông tin.";
                    loginError.classList.remove('hidden');
                    return;
                }

                showLoading(true);
                loginError.classList.add('hidden');
                
                const userId = userIdInput.value.trim();
                const examCode = examCodeInput.value.trim();
                currentExamCode = examCode;

                try {
                    if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);

                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                    const userDocSnap = await getDoc(userDocRef);
                    if (!userDocSnap.exists()) throw new Error("Tên đăng nhập không tồn tại.");
                    currentUser = { id: userDocSnap.id, ...userDocSnap.data() };

                    const examDocRef = doc(db, `artifacts/${appId}/public/data/exams`, examCode);
                    const examDocSnap = await getDoc(examDocRef);
                    if (!examDocSnap.exists()) throw new Error("Mã đề thi không hợp lệ.");
                    const examData = examDocSnap.data();
                    quizData = examData.questions;
                    
                    examTitleEl.innerText = `Đề thi: ${examData.title}`;
                    studentInfoEl.innerText = `Thí sinh: ${currentUser.name} - ID: ${currentUser.id}`;
                    startQuiz(examData.durationMinutes);
                } catch (error) {
                    console.error("An error occurred during login:", error);
                    loginError.innerText = error.message;
                    loginError.classList.remove('hidden');
                } finally {
                    showLoading(false);
                }
            });

            function startQuiz(durationMinutes) {
                loginScreen.classList.add('hidden');
                quizScreen.classList.remove('hidden');
                currentQuestionIndex = 0;
                userAnswers = new Array(quizData.length).fill(null);
                buildQuestionGrid();
                loadQuestion();
                startTimer(durationMinutes * 60);
            }
            
            function buildQuestionGrid() {
                questionGrid.innerHTML = '';
                quizData.forEach((_, i) => {
                    const btn = document.createElement('button');
                    btn.innerText = i + 1;
                    btn.className = 'question-grid-btn';
                    btn.addEventListener('click', () => { currentQuestionIndex = i; loadQuestion(); });
                    questionGrid.appendChild(btn);
                });
            }

            function updateQuestionGridStatus() {
                const gridButtons = questionGrid.querySelectorAll('button');
                gridButtons.forEach((btn, index) => {
                    btn.classList.remove('current', 'answered');
                    if (userAnswers[index] !== null) btn.classList.add('answered');
                    if (index === currentQuestionIndex) btn.classList.add('current');
                });
            }

            function loadQuestion() {
                const q = quizData[currentQuestionIndex];
                questionEl.innerText = q.question;
                questionCounterEl.innerText = `Câu ${currentQuestionIndex + 1} / ${quizData.length}`;
                optionsEl.innerHTML = '';
                q.options.forEach(option => {
                    const optionId = `option-${currentQuestionIndex}-${option.replace(/[^a-zA-Z0-9]/g, '')}`;
                    const optionDiv = document.createElement('div');
                    optionDiv.innerHTML = `<input type="radio" name="option" value="${option}" id="${optionId}" class="hidden"><label for="${optionId}" class="option-label block w-full text-left p-4 rounded-lg border-2 border-gray-300 cursor-pointer hover:bg-gray-100">${option}</label>`;
                    optionsEl.appendChild(optionDiv);
                    const label = optionDiv.querySelector('label');
                    if (userAnswers[currentQuestionIndex] === option) label.classList.add('selected');
                    label.addEventListener('click', () => {
                        document.querySelectorAll('.option-label').forEach(l => l.classList.remove('selected'));
                        label.classList.add('selected');
                        userAnswers[currentQuestionIndex] = option;
                        updateQuestionGridStatus();
                        updateProgressBar();
                    });
                });
                if (q.image) {
                    questionImage.src = q.image;
                    questionImage.classList.remove('hidden');
                    noImageText.classList.add('hidden');
                } else {
                    questionImage.classList.add('hidden');
                    noImageText.classList.remove('hidden');
                }
                updateNavigation();
                updateProgressBar();
                updateQuestionGridStatus();
            }

            function updateNavigation() {
                prevBtn.disabled = currentQuestionIndex === 0;
                nextBtn.classList.toggle('hidden', currentQuestionIndex === quizData.length - 1);
                submitBtn.classList.toggle('hidden', currentQuestionIndex !== quizData.length - 1);
            }

            function updateProgressBar() {
                const answeredCount = userAnswers.filter(a => a !== null).length;
                progressBar.style.width = `${(answeredCount / quizData.length) * 100}%`;
            }
            
            async function showResults() {
                clearInterval(timerInterval);
                showLoading(true);
                let scoreCount = 0;
                quizData.forEach((q, i) => { if (userAnswers[i] === q.answer) scoreCount++; });
                const percentage = Math.round((scoreCount / quizData.length) * 100);

                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/results`), {
                        userId: currentUser.id, userName: currentUser.name, examCode: currentExamCode,
                        score: percentage, correctAnswers: scoreCount, totalQuestions: quizData.length,
                        submittedAt: new Date()
                    });
                } catch (error) { console.error("Error saving result: ", error); }

                scoreEl.innerText = `${percentage}%`;
                buildReviewSection();
                quizScreen.classList.add('hidden');
                resultScreen.classList.remove('hidden');
                showLoading(false);
            }
            
            function buildReviewSection() {
                reviewContainer.innerHTML = '';
                quizData.forEach((q, i) => {
                    const isCorrect = userAnswers[i] === q.answer;
                    const container = document.createElement('div');
                    container.className = 'p-4 rounded-lg border';
                    container.classList.add(isCorrect ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50');

                    let optionsHTML = q.options.map(opt => {
                        let labelClass = 'option-label block w-full text-left p-3 rounded-lg border-2 border-gray-300 mt-2';
                        if (opt === q.answer) labelClass += ' correct';
                        if (opt === userAnswers[i] && !isCorrect) labelClass += ' incorrect';
                        return `<div><label class="${labelClass}">${opt}</label></div>`;
                    }).join('');

                    container.innerHTML = `
                        <p class="font-bold text-gray-800">Câu ${i + 1}: ${q.question}</p>
                        <div class="mt-2">${optionsHTML}</div>
                    `;
                    reviewContainer.appendChild(container);
                });
            }

            function startTimer(durationSeconds) {
                let timeLeft = durationSeconds;
                timerInterval = setInterval(() => {
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài! Hệ thống sẽ tự động nộp bài.");
                        showResults();
                    }
                }, 1000);
            }

            nextBtn.addEventListener('click', () => { if (currentQuestionIndex < quizData.length - 1) { currentQuestionIndex++; loadQuestion(); } });
            prevBtn.addEventListener('click', () => { if (currentQuestionIndex > 0) { currentQuestionIndex--; loadQuestion(); } });
            submitBtn.addEventListener('click', () => { if (confirm("Bạn có chắc chắn muốn nộp bài không?")) showResults(); });
            logoutBtn.addEventListener('click', () => location.reload());
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', main);
        } else {
            main();
        }
    </script>
</body>
</html>
